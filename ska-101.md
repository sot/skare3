# Ska 101

The Ska runtime environment is an integrated suite of Python and Perl packages and
associated applications. This environment is used for many facets of Chandra operations:

- Mission critical functions:
  - Mission planning
  - Load review
  - SOT MTA (Monitoring, trends, alerts)
  - Find attitude from full-field search stars
- SOT and FOT spacecraft and science instrument analysis
- SOT Aspect / ACA
  - Trending
  - Operations tools (find attitude, ACA image viewer)

Ska is supported on linux-64, Windows-64, and MacOS ARM-64. The aspect team is
responsible for the management, release, and deployment of the Ska runtime environment.

Managing Ska requires substantial resources. The Aspect team release manager maintains
numerous scripts and GitHub workflow actions for automated nightly integration
testing of all packages (in development), automated package building on target
architectures, documentation build and deployment, release documentation, and more.

Package development:
- Done by the Chandra operations community using open-source process on GitHub.
- Packages hosted at https://github.com/sot and https://github.com/acisops
  (ACIS-specific).

## What's in Ska?

At the highest level Ska includes the following:
- Packages developed and maintained by Chandra operations (e.g. `xija` or `kadi`).
  - Known as the `ska3-flight` or `ska3-matlab` packages.
  - About 50 distinct packages.
  - Updated and released about 10 times per year.
- Off-the-shelf Packages from the open-source community (e.g. `numpy` or `matplotlib`).
  - Known as the `ska3-core` packages.
  - Nearly 500 distinct packages.
  - Normally updated once per year, including an update of the major Python version.
- Optional components:
  - Perl interpreter and various Perl packages.
  - "Non-FSDS" packages for processing, trending, etc. These get installed to the HEAD
    production environment but have different control authority.

### Key flight packages

- [chandra_maneuver](https://sot.github.io/chandra_maneuver): Compute Chandra maneuver profile.
- [cheta](https://sot.github.io/cheta): Fast (10^7 / s) telemetry archive, plus an interface to MAUDE telemetry.
  - Fun fact: cheta code was forked (copied) and adapted for use by JWST, with 30000+
    MSIDs and higher data rates. Many mods and a fancy web telemetry viewer, but the basic architecture and code remains!
- [cxotime](https://sot.github.io/cxotime): Represent times with `CxoTime` class and convert between formats.
- [xija](https://sot.github.io/xija): Thermal modeling infrastructure.
- [proseco](https://sot.github.io/proseco): ACA star catalog selection.
- [sparkles](https://sot.github.io/sparkles): ACA star catalog review.
- [kadi](https://sot.github.io/kadi):
  - `events`: Key events from telemetry or iFOT such as maneuvers, momentum dumps, SIM moves, Safe Modes, CAPs, etc.
  - `commands`: Archive of most commands run by Chandra since 2002.
  - `commands.states`: Spacecraft states such as SIM position from commands.
  - `occweb`: Read OCCweb pages or list directories.
- [parse_cm](https://sot.github.io/parse_cm): Parse load product files (backstop, DOT, maneuver summary)
- [ska_sun](https://sot.github.io/ska_sun): Sun ephemeris.
- [Quaternion](https://sot.github.io/Quaternion): Represent and manipulate quaternions.

### Key core packages

- `astropy`: Tables, time, coordinates, I/O (CSV, FITS, HDF5).
- `beautifulsoup4`: HTML parsing.
- `ipython`: Interactive Python.
- `jplephem`: Planets and other JPL ephemeris handling.
- `jupyter`: Jupyter notebooks (with `jupyterlab` as well).
- `matplotlib`: Plotting (most common).
- `numba`: Make Python code run at C speed.
- `numexpr`: Make Python expressions run faster.
- `numpy`: Core numerical library for Python.
- `pandas`: Provide data structures for working with labeled data.
- `plotly`: Make interactive HTML plots.
- `pyqt`: GUI applications.
- `requests`: HTTP requests for humans.
- `scikit-learn`: Machine learning in Python.
- `scipy`: Fundamental algorithms for scientific Python.
- `sqlalchemy`: Python SQL toolkit and Object Relational Mapper.

### Generally useful flight packages

- [agasc](https://sot.github.io/agasc): ACA star catalog access and maintenance.
- [chandra_aca](https://sot.github.io/chandra_aca): Collection of sub-packages related to ACA - focus on functions.
  - `planets`: Get planet positions using JPL DE432s or Horizons.
- [chandra_limits](https://sot.github.io/chandra_limits): Chandra planning limits management.
- [maude](https://sot.github.io/maude): Low-level interface to MAUDE telemetry server.
- [mica](https://sot.github.io/mica): Collection of sub-packages related to ACA.
  - [Chandra Data Archive and OCAT](https://sot.github.io/mica/cda_ocat.html)
- [ska_dbi](https://sot.github.io/ska_dbi): Access databases.
- [ska_ftp](https://sot.github.io/ska_ftp): FTP access.
- [ska_helpers](https://sot.github.io/ska_helpers): Common utilities for Ska packages. Most generally useful:
  - `chandra_models`: Access different versions of `chandra_models`
  - `logging`: Wrapper around Python `logging` to make it easier to use.
- [ska_matplotlib](https://sot.github.io/ska_matplotlib): Make time-based plot using CXC format for dates.
- [ska_numpy](https://sot.github.io/ska_numpy): Performant functions for filtering and smoothing numpy arrays or record arrays.
- [ska_tdb](https://sot.github.io/ska_tdb): Access and search the Telemetry Database (TDB).
- [testr](https://sot.github.io/testr): Utilities related to unit testing including some handy helpers.

### Domain specific flight packages

- [aca_view](https://sot.github.io/aca_view): ACA image viewer application (real-time and archival).
- `acis_taco`: Compute Earth illumination on ACIS radiator.
- [acis_thermal_check](https://sot.github.io/acis_thermal_check): Thermal load review for ACIS and HRC.
- `acispy`: Utilities for ACIS.
- `backstop_history`: ACIS load review backstop history.
- `fot-matlab`: Python interface scripts for MATLAB tools.
- [ska_arc5gl](https://sot.github.io/ska_arc5gl): Access to CXC archive.
- `ska_sync`: Sync Ska data to another machine.
- [starcheck](https://sot.github.io/starcheck): ACA load review.

### Legacy - Do NOT use in new code

- [chandra_time](https://sot.github.io/chandra_time): Time package providing `DateTime` class.
- `hopper`: Orphaned package still used for ACA load review.
- `pyyaks`: Logging and context-dependent variables.
- `ska-sphinx-theme`: Documenation theme.
- [ska_astro](https://sot.github.io/ska_astro): Astro functions (?)
- [ska_file](https://sot.github.io/ska_file): File functions. (Note: `contextlib.chdir()` since Python 3.11).
- [ska_parsecm](https://sot.github.io/ska_parsecm): Original version of [parse_cm](https://sot.github.io/parse_cm), deprecated now.
- `ska_path`: Ska-specific path library that fizzled.
- [ska_shell](https://sot.github.io/ska_shell): Run system commands - mostly replaced by `subprocess`.
- [ska_quatutil](https://sot.github.io/ska_quatutil): Functions that are now available
  in [Quaternion](https://sot.github.io/Quaternion) or
  [chandra_aca](https://sot.github.io/chandra_aca).

## Getting help

### Documentation

Most Ska packages have online documentation that can be found at: https://sot.github.io/.

### Community support

Writing and maintaining documentation is difficult. If you have a question that is not
quickly answered by the online docs then **ASK THE COMMUNITY!!**.

The best approach is to ask on Slack in the `#analysis-coding` channel:

- Do not spend too much time struggling to figure something out.
- No question is too basic.
- Community "experts" genuinely enjoy answering code questions.
- If you are starting to write some basic utility, it may have already been written. Ask
  first!

### Use the Source, Luke

All the source code for Ska flight packages is available on GitHub at
https://github.com/sot. Caveat: Some packages (e.g. `parse_cm`, `maude`,
`chandra_maneuver`, `chandra_limits`) are private and visible only to the 20 `sot`
organization members.

This can be useful:
- Navigate to https://github.com/sot and then Search for a function.
- This should show both the function definition and examples of other code that uses it.

## Ska data latency

Ska depends on data products that are maintained largely via automated cron jobs that
run on HEAD linux machines. These data are then synced to GRETA (`chimchim`) on a daily
basis. Here we describe the timing of key cron jobs.

### Cheta telemetry archive

Cron processing to ingest CXC L0 telemetry starts at 4am local each morning and
generally finished by 6:30am. Typically, data from all previous comms will be available.
Processing finishes by updating the cheta sync archive which is used for maintaining a
local copy of the cheta archive.

When there is safe mode or other issue that significantly impacts the clock correlation,
then CXCDS processing waits for a new clock correlation. This can take several days, so
during that time the CXC L0 telemetry processing halts and cheta telemetry stops getting
updated.

### Kadi

#### Events

Kadi events depend on telemetry. Processing starts at 7am and finishes in a minute or
two.

**COMING SOON!!** -- kadi events will be updated on HEAD and GRETA within an hour of
data being available in MAUDE: https://github.com/sot/kadi/pull/343

#### Commands

The Kadi commands archive files are udpated on HEAD every 10 minutes. However, the
architecture of kadi commands is that commanding within the last 30 days is dynamically
generated based on the Command Events sheet, so ....

### Syncing from HEAD to GRETA

Ska data are synced from HEAD to GRETA each morning at 7:30am local. This finishes
within 15 minutes.

## How to use Ska

### HEAD or GRETA linux

This is simple since everything is pre-installed:
```
source /proj/sot/ska3/flight/bin/ska_envs.csh
```
It is highly recommended that you [create a `ska3`
alias](https://github.com/sot/skare3/wiki/Ska3-runtime-environment-for-users#Linux-alias-for-production-Ska3)
to also update your prompt to indicate that Ska3 is active.

You can quickly check that things are working in the [Testing
Ska3](https://github.com/sot/skare3/wiki/Ska3-runtime-environment-for-users#testing-ska3)
section.

#### Remote access

You can use Ska on your laptop via a remote SSH connection to `chimchim` or a HEAD linux machine with a VS code remote SSH session.
- VS code provides a terminal and Jupyter notebook interface.
- Feels like editing and running in your native OS, but with full access to Ska.
- FOT MP are successfully using this approach.

### Mac or linux laptop

The [user guide for Ska](https://github.com/sot/skare3/wiki/Ska3-runtime-environment-for-users)
gives details for using, installing, and maintaining the Ska runtime environment.

### FOT Windows laptop

Ska is bundled in the FOT MATLAB tools and is used extensively from the MATLAB code.
Using that bundled Ska directly is possible with the right incantations.

## Questions you might have

`Ska3` vs `Ska`:
- You often see "Ska3", which refers to current Ska with Python 3.
- Legacy Ska using Python 2 installed on HEAD and chimchim for old production scripts.
- For common use, "Ska" is the same as "Ska3".

`ska_matplotlib` vs `Ska.Matplotlib` (package names):
- In older code you will see package names like `Ska.Matplotlib` or `Chandra.Time`.
- These "namespace" packages (with the dot) are a legacy of Perl conventions.
- They cause all sorts of problems.
- We have migrated to all lower case with underscores for new code.
- Special case: `Ska.engarchive` => `cheta`. ALWAYS use `cheta` for new code.

`CxoTime` vs `DateTime`:
- Both classes provide time representation.
- `DateTime` is legacy, based on old C++ code that is not actively maintained.
- `CxoTime` is faster, better, and maintained. ALWAYS use this.
- Simply substituting `DateTime` -> `CxoTime` in older code will generally work, with
  [some caveats](https://sot.github.io/cxotime/#compatibility-with-datetime).

Astropy `Table` vs pandas `DataFrame`:
- Ska flight packages use only astropy `Table` for tables -> consistency.
- Astropy `Table` supports several key features that are not in `DataFrame`:
  - Multi-dimensional column data, e.g. to store 8x8 pixel ACA images in a table.
  - Metadata in columns and table.
  - Native support for `CxoTime` as a table column.
- Transforming to `DataFrame` is easy with `tbl.to_pandas()`.

`Cheta` and `MAUDE`:

These two telemetry servers are *complementary*.

| Cheta | MAUDE |
| -- | -- |
| On-disk data (~225 Gb circa 2025) | Web server backed by data archvie (~Tb's) |
| Updated daily | Realtime + back-orbit soon after each comm |
| Fetch size limited only by memory | Fetch size limit of ~million (?) |
| Python-only | Python, Javascript (any language really) |
| State codes mostly match TDB (`3TSCMOV`) | State codes strictly match TDB |
| Trailing spaces like `"ON "`, `"OFF"` | No trailing spaces `"ON"`, `"OFF"` |
| Includes certain SI telemetry (ACIS FP) | Does not include SI telemetry |

You can [access MAUDE from
cheta](https://sot.github.io/cheta/fetch_tutorial.html#maude-telemetry-server). Cheta
can even automatically stitch together data from the fast on-archive plus fill in the
most recent available data from MAUDE.

`kadi events` vs `kadi commands` vs `kadi states`:

Kadi events are from telemetry and web resources:
- Events in telemetry such as maneuvers, NPM dwells, obsids, mech movements, momentum
  dumps, orbit events, and so forth.
- Events from web resources, for instance CAPs, DSN passes, Load segments, and Chandra
  major events.

Kadi commands:
- Every load command run on-board *or approved*, with a link to source load products.
- Non-load commands which result from either autonomous on-board commanding (e.g.
  SCS-107) or real-time ground commanding (e.g. anomaly recovery).
- Includes predictive commands (expected to happen).

Kadi states:
- State(s) of Chandra derived from kadi commands.
- Examples include Sun pitch angle, SIM position, ACIS configuration.
- Also predictive.

Data:
| Kadi events | Kadi commands and states |
| -- | -- |
| SQLite database | HDF5 files + local files |
| Updated on HEAD | HDF5 files updated on HEAD + on-the-fly from OCCweb |
| Current as of last sync | ALWAYS current |

## Random thoughts

- Computing a xija ACA thermal model over safe modes interval and compare to telemetry
  - Xija model
  - Cheta telemetry
  - Kadi states

- Show cheta quaternion comps
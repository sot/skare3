# Ska 101

The Ska runtime environment is an integrated suite of Python and Perl packages and
associated applications. This environment is used for many facets of Chandra operations:

- Mission critical functions:
  - Mission planning
  - Load review
  - SOT MTA (Monitoring, trends, alerts)
  - Find attitude from full-field search stars
- SOT and FOT spacecraft and science instrument analysis
- SOT Aspect / ACA
  - Trending
  - Operations tools (find attitude, ACA image viewer)

Ska is supported on linux-64, Windows-64, and MacOS ARM-64. The aspect team is
responsible for the management, release, and deployment of the Ska runtime environment.

Managing Ska requires substantial resources. The Aspect team release manager maintains
sophisticated scripts and GitHub workflow actions for automated nightly integration
testing of all packages (in development), automated package building on target
architectures, documentation build and deployment, release documentation, and more.

Package development:
- Done by the Chandra operations community using open-source process on GitHub.
- Packages hosted at https://github.com/sot and https://github.com/acisops
  (ACIS-specific).

### Questions you might have

Ska3 vs Ska:
- You often see "Ska3", which refers to current Ska with Python 3.
- Legacy Ska using Python 2 installed on HEAD and chimchim for old production scripts.
- For common use, "Ska" is the same as "Ska3".

`ska_matplotlib` vs `Ska.Matplotlib` (package names):
- In older code you will see package names like `Ska.Matplotlib` or `Chandra.Time`.
- These "namespace" packages (with the dot) are a legacy of Perl conventions.
- They cause all sorts of problems.
- We have migrated to all lower case with underscores for new code.
- Special case: `Ska.engarchive` => `cheta`. ALWAYS use `cheta` for new code.

`CxoTime` vs `DateTime`:
- Both classes provide time representation.
- `DateTime` is legacy, based on old C++ code that is not actively maintained.
- `CxoTime` is faster, better, and maintained. ALWAYS use this.
- Simply substituting `DateTime` -> `CxoTime` in older code will generally work, with [some caveats](https://sot.github.io/cxotime/#compatibility-with-datetime).

Astropy `Table` vs pandas `DataFrame`:
- Ska flight packages use only astropy `Table` for tables -> consistency.
- Astropy `Table` supports several key features that are not in `DataFrame`:
  - Multi-dimensional column data, e.g. to store 8x8 pixel ACA images in a table.
  - Metadata in columns and table.
  - Native support for `CxoTime` as a table column.
- Transforming to `DataFrame` is easy with `tbl.to_pandas()`.

## How to use Ska

### HEAD or GRETA linux

This is simple since everything is pre-installed:
```
source /proj/sot/ska3/flight/bin/ska_envs.csh
```
It is highly recommended that you [create a `ska3` alias](https://github.com/sot/skare3/wiki/Ska3-runtime-environment-for-users#Linux-alias-for-production-Ska3) to also update your prompt to indicate that Ska3 is active.

You can quickly check that things are working in the [Testing Ska3](https://github.com/sot/skare3/wiki/Ska3-runtime-environment-for-users#testing-ska3) section.

#### Remote access

You can use Ska on your laptop via a remote SSH connection to `chimchim` or a HEAD linux machine with a VS code remote SSH session.
- VS code provides a terminal and Jupyter notebook interface.
- Feels like editing and running in your native OS, but with full access to Ska.
- FOT MP are successfully using this approach..

### Mac or linux laptop

The [user guide for Ska](https://github.com/sot/skare3/wiki/Ska3-runtime-environment-for-users)
gives details for using, installing, and maintaining the Ska runtime environment.

## What's in Ska?

At the highest level Ska includes the following:
- Packages developed and maintained by Chandra operations (e.g. `xija` or `kadi`).
  - Known as the `ska3-flight` or `ska3-matlab` packages.
  - About 50 distinct packages.
  - Updated and released about 10 times per year.
- Off-the-shelf Packages from the open-source community (e.g. `numpy` or `matplotlib`).
  - Known as the `ska3-core` packages.
  - Nearly 500 distinct packages.
  - Normally updated once per year, including an update of the major Python version.
- Optional components:
  - Perl interpreter and various Perl packages.
  - "Non-FSDS" packages for processing, trending, etc. These get installed to the HEAD
    production environment but have different control authority.

### Core packages

- `chandra_maneuver`: Compute Chandra maneuver profile.
- `cheta`: Fast (10^7 / s) telemetry archive, plus an interface to MAUDE telemetry.
- `cxotime`: Represent times with `CxoTime` class and convert between formats.
- `xija`: Thermal modeling infrastructure.
- `proseco`: ACA star catalog selection.
- `sparkles`: ACA star catalog review.
- `kadi`:
  - `events`: Key events from telemetry such as maneuvers, normal sun modes.
  - `commands`: Archive of most commands run by Chandra since 2002.
  - `commands.states`: Spacecraft states such as SIM position from commands.
  - `occweb`: Read OCCweb pages or list directories.
- `parse_cm`: Parse load product files (backstop, DOT, maneuver summary)
- `ska_sun`: Sun ephemeris
- `quaternion`: Represent and manipulate quaternions.

### Generally useful

- `agasc`: ACA star catalog access and maintenance.
- `chandra_aca`: Collection of sub-packages related to ACA - focus on functions.
  - `planets`: Get planet positions using JPL DE432s or Horizons.
- `chandra_limits`: Chandra planning limits management.
- `maude`: Low-level interface to MAUDE telemetry server.
- `ska_dbi`: Access databases.
- `ska_ftp`: FTP access.
- `ska_helpers`: Common utilities for Ska packages. Most generally useful:
  - `chandra_models`: Access different versions of `chandra_models`
  - `logging`: Wrapper around Python `logging` to make it easier to use.
- `ska_matplotlib`: Make time-based plot using CXC format for dates.
- `ska_numpy`: Performant functions for filtering and smoothing numpy arrays or record arrays.
- `ska_tdb`: Access and search the Telemetry Database (TDB).
- `testr`: Utilities related to unit testing including some handy helpers.

### Domain specific

- `aca_view`: ACA image viewer application (real-time and archival).
- `acis_taco`: Compute Earth illumination on ACIS radiator.
- `acis_thermal_check`: Thermal load review for ACIS and HRC.
- `acispy`: Utilities for ACIS.
- `backstop_history`: ACIS load review backstop history.
- `fot-matlab`: Python interface scripts for MATLAB tools.
- `mica`: Collection of sub-packages related to ACA - focus on data retrieval.
- `ska_arc5gl`: Access to CXC archive.
- `ska_sync`: Sync Ska data to another machine.
- `starcheck`: ACA load review.

### Legacy - Do NOT use in new code

- `chandra_time`: Time package providing `DateTime` class.
- `hopper`: Orphaned package still used for ACA load review.
- `pyyaks`: Logging and context-dependent variables.
- `ska-sphinx-theme`: Documenation theme.
- `ska_astro`: Astro functions (?)
- `ska_file`: File functions. (Note: `contextlib.chdir()` since Python 3.11).
- `ska_parsecm`: Original version of `parse_cm`, deprecated now.
- `ska_path`: Ska-specific path library that fizzled.
- `ska_shell`: Run system commands - mostly replaced by `subprocess`.
- `ska_quatutil`: Functions that are now available in `Quaternion` or `chandra_aca`.

## Getting help

### Documentation

Most Ska packages have online documentation that can be found at: https://sot.github.io/.

### Community support

Writing and maintaining documentation is difficult. If you have a question that is not quickly answered by the online docs then **ASK THE COMMUNITY!!**.

The best approach is to ask on Slack in the `#analysis-coding` channel. Thoughts and advice:

- Do not spend too much time struggling to figure something out.
- No question is too basic.
- Community "experts" genuinely enjoy answering code questions.
- If you are starting to write some basic utility, it may have already been written. Ask first!
